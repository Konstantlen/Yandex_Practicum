?????? SQL ?1

??????? stackoverflow.badges. ?????? ?????????? ? ???????, ??????? ???????????? ?? ?????? ??????????. ????????, ????????????, ????????? ?????????? ?? ??????? ?????????? ???????? ??? PostgreSQL, ????? ???????? ?????? postgresql.
??????? stackoverflow.post_types. ???????? ?????????? ? ???? ??????. ?? ????? ???? ???: Question — ???? ? ????????; Answer — ???? ? ???????.
??????? stackoverflow.posts. ???????? ?????????? ? ??????
??????? stackoverflow.users. ???????? ?????????? ? ?????????????
??????? stackoverflow.vote_types. ???????? ?????????? ? ????? ???????. ????? — ??? ?????, ??????? ???????????? ?????? ?????. ????? ?????? ?????????: UpMod — ????? ??????? ???????? ????? ? ????????? ??? ????????, ??????? ???????????? ????????? ????????? ? ?????????. DownMod — ????? ??????? ???????? ?????, ??????? ?????????? ????????????? ???????? ?????????. Close — ????? ????? ?????? ??????? ???????????? ???????, ???? ???????? ?????? ????? ?????????? ??? ?? ?????? ?? ???????? ??? ?????????. Offensive — ????? ????? ????? ?????????, ???? ???????????? ??????? ?? ?????? ? ?????? ? ?????????????? ??????, ????????, ?????? ?? ??????????? ?????? ?????. Spam — ????? ????? ?????? ? ??????, ???? ???? ???????????? ???????? ??????????? ????????.
??????? stackoverflow.votes ???????? ?????????? ? ??????? ?? ?????.

1.
??????? ?????????? ????????, ??????? ??????? ?????? 300 ????? ??? ??? ??????? 100 ??? ???? ????????? ? «????????».

SELECT COUNT(p.id)
FROM stackoverflow.posts AS p
WHERE p.post_type_id = 1
AND (p.score > 300 OR p.favorites_count >= 100);

2.
??????? ? ??????? ? ???? ???????? ???????? ? 1 ?? 18 ?????? 2008 ????????????? ????????? ????????? ?? ?????? ?????.

SELECT ROUND(AVG(questions))
FROM
(SELECT creation_date::date as dt,
       COUNT(id) as questions
FROM stackoverflow.posts as p
WHERE post_type_id = 1
AND creation_date::date BETWEEN '2008-11-1' AND '2008-11-18'
GROUP BY dt) AS shit;

3.
??????? ????????????? ???????? ?????? ????? ? ???? ???????????? ???????? ?????????? ?????????? ?????????????.

SELECT COUNT(u.id)
FROM stackoverflow.users AS u
JOIN stackoverflow.badges AS b ON u.id=b.user_id
WHERE u.creation_date::date = b.creation_date::date


4.
??????? ?????????? ?????? ???????????? ? ?????? Joel Coehoorn ???????? ???? ?? ???? ??????

SELECT COUNT(DISTINCT p.id)
FROM stackoverflow.posts as p
JOIN stackoverflow.votes as v ON p.id = v.post_id
JOIN stackoverflow.users as u ON p.user_id = u.id
WHERE u.display_name = 'Joel Coehoorn';

5.
????????? ??? ???? ??????? vote_types. ???????? ? ??????? ???? rank, ? ??????? ?????? ?????? ??????? ? ???????? ???????. ??????? ?????? ???? ????????????? ?? ???? id.

SELECT *,
       RANK () OVER (ORDER BY id DESC)
FROM stackoverflow.vote_types 
ORDER BY id;

6.
???????? 10 ?????????????, ??????? ????????? ?????? ????? ??????? ???? Close. ?????????? ??????? ?? ???? ?????: ??????????????? ???????????? ? ??????????? ???????. ???????????? ?????? ??????? ?? ???????? ?????????? ???????, ????? ?? ???????? ???????? ?????????????? ????????????.

SELECT u.id as i,
       COUNT(v.id) as f
FROM stackoverflow.users as u
JOIN stackoverflow.votes as v ON u.id=v.user_id
JOIN stackoverflow.vote_types as vt ON vt.id = v.vote_type_id
WHERE vt.name = 'Close'
GROUP BY i
ORDER BY f DESC, i DESC
LIMIT 10;

7.
???????? 10 ????????????? ?? ?????????? ???????, ?????????? ? ?????? ? 15 ?????? ?? 15 ??????? 2008 ???? ????????????. ?????????? ????????? ?????:
* ????????????? ????????????;
* ????? ???????;
* ????? ? ???????? — ??? ?????? ???????, ??? ???? ???????.
?????????????, ??????? ??????? ?????????? ?????????? ???????, ????????? ???? ? ?? ?? ????? ? ????????.
???????????? ?????? ?? ?????????? ??????? ?? ????????, ? ????? ?? ??????????? ???????? ?????????????? ????????????.

SELECT DISTINCT u.id as i,
       COUNT(b.id) as badges,
       DENSE_RANK() OVER (ORDER BY COUNT(b.id)DESC) 
FROM stackoverflow.users as u
JOIN stackoverflow.badges as b ON u.id=b.user_id
WHERE b.creation_date::date BETWEEN '2008-11-15' AND '2008-12-15'
GROUP BY i
ORDER BY badges DESC, i
LIMIT 10;

8.
??????? ? ??????? ????? ???????? ???? ??????? ?????????????
??????????? ??????? ?? ????????? ?????:
* ????????? ?????;
* ????????????? ????????????;
* ????? ????? ?????;
* ??????? ????? ????? ???????????? ?? ????, ??????????? ?? ?????? ?????.
?? ?????????? ????? ??? ?????????, ? ????? ??, ??? ??????? ???? ?????.

SELECT p.title t,
       u.id i,
       p.score s,
       ROUND(AVG(p.score) OVER (PARTITION BY u.id)) as avg
FROM stackoverflow.users as u
JOIN stackoverflow.posts as p ON u.id=p.user_id
WHERE p.title != ''
AND p.score != 0
GROUP BY t, i, s, p.id;

9.
?????????? ????????? ??????, ??????? ???? ???????? ??????????????, ??????????? ????? 1000 ???????. ????? ??? ?????????? ?? ?????? ??????? ? ??????.

SELECT p.title t
FROM stackoverflow.posts AS p
WHERE p.user_id IN
(SELECT u.id
FROM stackoverflow.users AS u
JOIN stackoverflow.badges AS b ON u.id=b.user_id
GROUP BY u.id
HAVING COUNT(b.id)>1000)
AND p.title IS NOT NULL;

10.
???????? ??????, ??????? ???????? ?????? ? ????????????? ?? ??? (????. United States). ????????? ????????????? ?? ??? ?????? ? ??????????? ?? ?????????? ?????????? ?? ????????:
* ????????????? ? ?????? ?????????? ?????? ???? ?????? 350 ????????? ?????? 1;
* ????????????? ? ?????? ?????????? ?????? 350, ?? ?????? ???? ????? 100 — ?????? 2;
* ????????????? ? ?????? ?????????? ?????? 100 — ?????? 3.
?????????? ? ???????? ??????? ????????????? ????????????, ?????????? ?????????? ??????? ? ??????. ???????????? ? ??????? ??????????? ?????????? ?? ?????? ????? ? ???????? ???????.

SELECT u.id,
       u.views,
       CASE
            WHEN u.views >= 350 THEN 1
            WHEN 350 > u.views AND u.views >= 100 THEN 2
            WHEN u.views < 100 THEN 3
       END as gr
FROM stackoverflow.users AS u
WHERE u.views != 0
AND u.location LIKE ('%United States%');

11.
????????? ?????????? ??????. ?????????? ??????? ?????? ?????? — ?????????????, ??????? ??????? ???????????? ????? ?????????? ? ????? ??????. ???????? ???? ? ??????????????? ????????????, ??????? ? ??????????? ??????????. ???????????? ??????? ?? ???????? ??????????, ? ????? ?? ??????????? ???????? ??????????????.

WITH g AS
(SELECT u.id,
       u.views,
       CASE
            WHEN u.views >= 350 THEN 1
            WHEN 350 > u.views AND u.views >= 100 THEN 2
            WHEN u.views < 100 THEN 3
       END as gr
FROM stackoverflow.users AS u
WHERE u.views != 0
AND u.location LIKE ('%United States%')
 )
SELECT id,
         views,
         gr,
         MAX(views) OVER (PARTITION BY g.gr) AS vmax
FROM g
ORDER BY views DESC, id;

12.
?????????? ?????????? ??????? ????? ????????????? ? ?????? 2008 ????. ??????????? ??????? ? ??????:
* ????? ???;
* ????? ?????????????, ?????????????????? ? ???? ????;
* ????? ????????????? ? ???????????.
SELECT DISTINCT EXTRACT(DAY FROM creation_date::date) as cd,
       COUNT(id) OVER (PARTITION BY creation_date::date) as n,
       COUNT(id) OVER (ORDER BY creation_date::date) s
FROM stackoverflow.users as u
WHERE creation_date::date BETWEEN '2008-11-01' AND '2008-11-30';
13.
??? ??????? ????????????, ??????? ??????? ???? ?? ???? ????, ??????? ???????? ????? ???????????? ? ???????? ???????? ??????? ?????. ??????????:
* ????????????? ????????????;
* ??????? ?? ??????? ????? ???????????? ? ?????? ??????.
SELECT DISTINCT users.id as u,
       MIN(posts.creation_date) OVER (PARTITION BY posts.user_id) - users.creation_date as dif
FROM stackoverflow.posts
JOIN stackoverflow.users ON posts.user_id=users.id
ORDER BY u;
